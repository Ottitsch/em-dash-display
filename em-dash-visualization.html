<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Em-Dash Usage Across Subreddits</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            grid-gap: 20px;
        }
        .controls {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        select, button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background-color: white;
            font-size: 14px;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #3367d6;
        }
        .chart-container {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tooltip {
            position: absolute;
            background: rgba(255,255,255,0.95);
            border: 1px solid #aaa;
            padding: 10px;
            border-radius: 4px;
            pointer-events: none;
            font-size: 14px;
            max-width: 300px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .examples-panel {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .examples-panel h3 {
            margin-top: 0;
            margin-bottom: 12px;
        }
        .example-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 3px solid #4285f4;
        }
        .example-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .example-text {
            font-size: 14px;
            line-height: 1.5;
        }
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .tab-button {
            padding: 8px 15px;
            border: none;
            background-color: #eee;
            color: #333;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #4285f4;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            display: inline-block;
        }
        .axis-label {
            font-size: 12px;
            fill: #555;
        }
        .bar-highlight {
            stroke: #ff9800;
            stroke-width: 2px;
        }
        #time-chart, #bar-chart {
            width: 100%;
            height: 400px;
        }
        #loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Em-Dash Usage Across Subreddits</h1>
    
    <div id="loading">Loading data and initializing visualization...</div>

    <div class="dashboard" id="dashboard" style="display:none;">
        <div class="controls">
            <div>
                <label for="month-select">Select Month:</label>
                <select id="month-select"></select>
            </div>
            <div>
                <label for="sort-select">Sort By:</label>
                <select id="sort-select">
                    <option value="name">Subreddit Name</option>
                    <option value="percent" selected>Em-Dash Percentage</option>
                    <option value="posts">Number of Posts</option>
                </select>
            </div>
            <div>
                <label for="filter-select">Filter:</label>
                <select id="filter-select">
                    <option value="all">All Subreddits</option>
                    <option value="positive">Only With Em-Dashes (>0%)</option>
                    <option value="top10">Top 10 by Em-Dash %</option>
                </select>
            </div>
        </div>

        <div class="tab-buttons">
            <button class="tab-button active" data-tab="bar-chart-tab">Subreddit Comparison</button>
            <button class="tab-button" data-tab="time-chart-tab">Trends Over Time</button>
        </div>

        <div class="tab-content active" id="bar-chart-tab">
            <div class="chart-container">
                <div id="bar-chart"></div>
            </div>
        </div>

        <div class="tab-content" id="time-chart-tab">
            <div class="chart-container">
                <div id="time-chart"></div>
            </div>
        </div>

        <div class="examples-panel">
            <h3>Em-Dash Examples</h3>
            <p id="examples-placeholder">Select a subreddit from the chart to see examples.</p>
            <div id="examples-container"></div>
        </div>
    </div>

    <script>
        // Mock data structure to match what would be produced by the Python script
        const mockData = generateMockData();
        
        // Global state
        let state = {
            data: null,
            months: [],
            currentMonth: null,
            selectedSubreddit: null,
            sortBy: 'percent',
            filter: 'positive',
            activeTab: 'bar-chart-tab'
        };
        
        // Initialize everything once the data is loaded
        initializeVisualization(mockData);

        // Main initialization function
        function initializeVisualization(data) {
            state.data = data;
            
            // Extract and sort months
            state.months = [...new Set(data.map(d => d.month))].sort();
            state.currentMonth = state.months[state.months.length - 1]; // Latest month
            
            // Initialize UI controls
            initializeControls();
            
            // Initialize charts
            updateBarChart();
            updateTimeChart();
            
            // Show dashboard, hide loading
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            // Set up event listeners for tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    activateTab(tabId);
                });
            });
        }

        function activateTab(tabId) {
            // Update active state for tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('data-tab') === tabId) {
                    button.classList.add('active');
                }
            });
            
            // Update active state for tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            state.activeTab = tabId;
            
            // Refresh the active chart
            if (tabId === 'bar-chart-tab') {
                updateBarChart();
            } else if (tabId === 'time-chart-tab') {
                updateTimeChart();
            }
        }

        function initializeControls() {
            // Populate month selector
            const monthSelect = document.getElementById('month-select');
            state.months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = formatMonth(month);
                monthSelect.appendChild(option);
            });
            monthSelect.value = state.currentMonth;
            monthSelect.addEventListener('change', function() {
                state.currentMonth = this.value;
                updateBarChart();
                updateExamples();
            });
            
            // Set up sort selector
            document.getElementById('sort-select').addEventListener('change', function() {
                state.sortBy = this.value;
                updateBarChart();
            });
            
            // Set up filter selector
            document.getElementById('filter-select').addEventListener('change', function() {
                state.filter = this.value;
                updateBarChart();
            });
        }

        function updateBarChart() {
            // Get filtered data for the current month
            let filtered = state.data.filter(d => d.month === state.currentMonth);
            
            // Apply filter
            if (state.filter === 'positive') {
                filtered = filtered.filter(d => d.em_dash_percent > 0);
            } else if (state.filter === 'top10') {
                filtered = filtered.sort((a, b) => b.em_dash_percent - a.em_dash_percent).slice(0, 10);
            }
            
            // Apply sorting
            if (state.sortBy === 'name') {
                filtered = filtered.sort((a, b) => a.subreddit.localeCompare(b.subreddit));
            } else if (state.sortBy === 'percent') {
                filtered = filtered.sort((a, b) => b.em_dash_percent - a.em_dash_percent);
            } else if (state.sortBy === 'posts') {
                filtered = filtered.sort((a, b) => b.num_posts - a.num_posts);
            }
            
            const chartContainer = document.getElementById('bar-chart');
            const containerWidth = chartContainer.clientWidth;
            
            // Create chart dimensions
            const margin = {top: 40, right: 30, bottom: 100, left: 60};
            const width = containerWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;
            
            // Clear previous chart
            d3.select('#bar-chart').selectAll('*').remove();
            
            // Create SVG
            const svg = d3.select('#bar-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Create scales
            const x = d3.scaleBand()
                .domain(filtered.map(d => d.subreddit))
                .range([0, width])
                .padding(0.2);
                
            const y = d3.scaleLinear()
                .domain([0, d3.max(filtered, d => d.em_dash_percent) * 1.1])
                .nice()
                .range([height, 0]);
            
            // Create a tooltip
            const tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);
            
            // Add X axis
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em');
            
            // Add Y axis
            svg.append('g')
                .call(d3.axisLeft(y)
                    .ticks(5)
                    .tickFormat(d => d + '%'));
            
            // Add Y axis label
            svg.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('y', -margin.left + 15)
                .attr('x', -height / 2)
                .attr('text-anchor', 'middle')
                .text('Percentage of Posts with Em-Dashes');
            
            // Add title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', -margin.top / 2)
                .attr('text-anchor', 'middle')
                .style('font-size', '16px')
                .style('font-weight', 'bold')
                .text(`Em-Dash Usage by Subreddit (${formatMonth(state.currentMonth)})`);
            
            // Add bars
            svg.selectAll('.bar')
                .data(filtered)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.subreddit))
                .attr('width', x.bandwidth())
                .attr('y', d => y(d.em_dash_percent))
                .attr('height', d => height - y(d.em_dash_percent))
                .attr('fill', d => d.subreddit === state.selectedSubreddit ? '#ff9800' : '#4285f4')
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .attr('class', 'bar bar-highlight');
                    
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);
                    
                    tooltip.html(`
                        <strong>r/${d.subreddit}</strong><br>
                        Em-Dash Usage: <strong>${d.em_dash_percent.toFixed(2)}%</strong><br>
                        Posts with Em-Dashes: ${d.num_emdash} / ${d.num_posts}<br>
                        <em>Click for examples</em>
                    `)
                    .style('left', (event.pageX + 5) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
                })
                .on('mousemove', function(event) {
                    tooltip
                        .style('left', (event.pageX + 5) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this).attr('class', 'bar');
                    tooltip.transition()
                        .duration(500)
                        .style('opacity', 0);
                })
                .on('click', function(event, d) {
                    state.selectedSubreddit = d.subreddit;
                    updateBarChart();
                    updateExamples();
                });
            
            // Add value labels on top of bars
            svg.selectAll('.bar-label')
                .data(filtered)
                .enter()
                .append('text')
                .attr('class', 'bar-label')
                .attr('x', d => x(d.subreddit) + x.bandwidth() / 2)
                .attr('y', d => y(d.em_dash_percent) - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '10px')
                .text(d => `${d.em_dash_percent.toFixed(1)}%`);
        }

        function updateTimeChart() {
            // Clear the chart container
            d3.select('#time-chart').selectAll('*').remove();
            
            // Filter for top subreddits by em-dash percentage in the latest month
            const latestMonth = state.months[state.months.length - 1];
            const topSubreddits = state.data
                .filter(d => d.month === latestMonth && d.em_dash_percent > 0)
                .sort((a, b) => b.em_dash_percent - a.em_dash_percent)
                .slice(0, 5)
                .map(d => d.subreddit);
            
            // Filter data to include only these subreddits
            const filteredData = state.data.filter(d => topSubreddits.includes(d.subreddit));
            
            // Prepare dimensions
            const container = document.getElementById('time-chart');
            const containerWidth = container.clientWidth;
            
            const margin = {top: 40, right: 80, bottom: 60, left: 60};
            const width = containerWidth - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;
            
            // Create SVG
            const svg = d3.select('#time-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Create scales
            const x = d3.scalePoint()
                .domain(state.months)
                .range([0, width])
                .padding(0.5);
                
            const y = d3.scaleLinear()
                .domain([0, d3.max(filteredData, d => d.em_dash_percent) * 1.1])
                .nice()
                .range([height, 0]);
                
            const color = d3.scaleOrdinal()
                .domain(topSubreddits)
                .range(d3.schemeCategory10);
            
            // Create a tooltip
            const tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);
            
            // Add X axis
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x)
                    .tickFormat(d => formatMonth(d)))
                .selectAll('text')
                .attr('transform', 'rotate(-30)')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em');
            
            // Add Y axis
            svg.append('g')
                .call(d3.axisLeft(y)
                    .ticks(5)
                    .tickFormat(d => d + '%'));
            
            // Add Y axis label
            svg.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('y', -margin.left + 15)
                .attr('x', -height / 2)
                .attr('text-anchor', 'middle')
                .text('Percentage of Posts with Em-Dashes');
            
            // Add title
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', -margin.top / 2)
                .attr('text-anchor', 'middle')
                .style('font-size', '16px')
                .style('font-weight', 'bold')
                .text('Em-Dash Usage Trends Over Time (Top 5 Subreddits)');
            
            // Create line generator
            const line = d3.line()
                .x(d => x(d.month))
                .y(d => y(d.em_dash_percent))
                .curve(d3.curveMonotoneX);
            
            // Group data by subreddit
            const subredditData = {};
            topSubreddits.forEach(sub => {
                subredditData[sub] = filteredData.filter(d => d.subreddit === sub);
            });
            
            // Add lines for each subreddit
            Object.entries(subredditData).forEach(([subreddit, data]) => {
                svg.append('path')
                    .datum(data)
                    .attr('fill', 'none')
                    .attr('stroke', color(subreddit))
                    .attr('stroke-width', 2)
                    .attr('d', line);
                
                // Add dots for each data point
                svg.selectAll(`.dot-${subreddit.replace(/\s+/g, '-')}`)
                    .data(data)
                    .enter()
                    .append('circle')
                    .attr('class', `dot-${subreddit.replace(/\s+/g, '-')}`)
                    .attr('cx', d => x(d.month))
                    .attr('cy', d => y(d.em_dash_percent))
                    .attr('r', 4)
                    .attr('fill', color(subreddit))
                    .on('mouseover', function(event, d) {
                        d3.select(this)
                            .attr('r', 6)
                            .style('stroke', '#333')
                            .style('stroke-width', 2);
                        
                        tooltip.transition()
                            .duration(200)
                            .style('opacity', .9);
                        
                        tooltip.html(`
                            <strong>r/${d.subreddit}</strong><br>
                            Month: ${formatMonth(d.month)}<br>
                            Em-Dash Usage: <strong>${d.em_dash_percent.toFixed(2)}%</strong><br>
                            Posts with Em-Dashes: ${d.num_emdash} / ${d.num_posts}
                        `)
                        .style('left', (event.pageX + 5) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select(this)
                            .attr('r', 4)
                            .style('stroke', 'none');
                        
                        tooltip.transition()
                            .duration(500)
                            .style('opacity', 0);
                    })
                    .on('click', function(event, d) {
                        state.selectedSubreddit = d.subreddit;
                        state.currentMonth = d.month;
                        
                        // Update month selector
                        document.getElementById('month-select').value = d.month;
                        
                        // Switch to bar chart tab and update
                        activateTab('bar-chart-tab');
                        updateBarChart();
                        updateExamples();
                    });
            });
            
            // Add legend
            const legend = svg.append('g')
                .attr('class', 'legend')
                .attr('transform', `translate(${width - 20}, 0)`);
            
            topSubreddits.forEach((sub, i) => {
                const legendItem = legend.append('g')
                    .attr('transform', `translate(0, ${i * 20})`);
                
                legendItem.append('rect')
                    .attr('width', 12)
                    .attr('height', 12)
                    .attr('fill', color(sub));
                
                legendItem.append('text')
                    .attr('x', 20)
                    .attr('y', 10)
                    .style('font-size', '12px')
                    .text(`r/${sub}`);
            });
        }

        function updateExamples() {
            const examplesContainer = document.getElementById('examples-container');
            const placeholder = document.getElementById('examples-placeholder');
            
            // Clear previous examples
            examplesContainer.innerHTML = '';
            
            if (!state.selectedSubreddit) {
                placeholder.style.display = 'block';
                return;
            }
            
            placeholder.style.display = 'none';
            
            // Get examples for the selected subreddit
            const examples = state.data
                .filter(d => d.subreddit === state.selectedSubreddit)
                .filter(d => d.last_emdash_example)
                .sort((a, b) => new Date(b.month) - new Date(a.month));
            
            if (examples.length === 0) {
                examplesContainer.innerHTML = `<p>No em-dash examples found for r/${state.selectedSubreddit}.</p>`;
                return;
            }
            
            // Display examples
            examples.forEach(example => {
                const exampleDiv = document.createElement('div');
                exampleDiv.className = 'example-item';
                
                const metaDiv = document.createElement('div');
                metaDiv.className = 'example-meta';
                metaDiv.textContent = `r/${example.subreddit} · ${formatMonth(example.month)}`;
                
                const textDiv = document.createElement('div');
                textDiv.className = 'example-text';
                textDiv.textContent = example.last_emdash_example;
                
                exampleDiv.appendChild(metaDiv);
                exampleDiv.appendChild(textDiv);
                examplesContainer.appendChild(exampleDiv);
            });
        }

        // Helper functions
        function formatMonth(dateStr) {
            const date = new Date(dateStr);
            return new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short' }).format(date);
        }

        // Generate mock data to simulate what the Python script would produce
        function generateMockData() {
            const subreddits = [
                'AskReddit', 'worldnews', 'science', 'books', 'philosophy',
                'writing', 'politics', 'history', 'programming', 'technology',
                'movies', 'television', 'gaming', 'music', 'art'
            ];
            
            const startDate = new Date('2023-01-01');
            const endDate = new Date('2023-12-01');
            
            const months = [];
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                months.push(new Date(currentDate).toISOString().substring(0, 10));
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            
            const data = [];
            
            // Generate data for each subreddit and month
            subreddits.forEach(subreddit => {
                // Assign a baseline em-dash percentage for this subreddit
                const basePercent = Math.random() * 5 + (subreddit === 'philosophy' || subreddit === 'writing' ? 8 : 0);
                
                months.forEach((month, i) => {
                    // Apply some random variation month to month, with a slight upward trend
                    const trendFactor = i / months.length * 2; // Upward trend
                    const randomFactor = Math.random() * 2 - 1; // Random variation
                    
                    // Calculate em-dash percentage for this month
                    let emDashPercent = basePercent + trendFactor + randomFactor;
                    emDashPercent = Math.max(0, emDashPercent); // No negative percentages
                    
                    // Random number of posts, higher for popular subreddits
                    const popularityFactor = (subreddit === 'AskReddit' || subreddit === 'worldnews') ? 5 : 1;
                    const numPosts = Math.floor(Math.random() * 200 * popularityFactor) + 50;
                    
                    // Calculate number of posts with em-dashes
                    const numEmDash = Math.round((emDashPercent / 100) * numPosts);
                    
                    // Generate a random em-dash example
                    const emDashExamples = [
                        `The key insight of the study — which took researchers by surprise — was the correlation between sleep and productivity.`,
                        `I've tried everything — meditation, exercise, medication — but nothing seems to help with my insomnia.`,
                        `The company announced a major shift in strategy — focusing exclusively on renewable energy sources.`,
                        `Everyone has a plan — until they get punched in the mouth.`,
                        `The proposal outlined three main areas for improvement — infrastructure, education, and healthcare.`,
                        `The author's style — verbose yet precise — creates a unique reading experience.`,
                        `There's only one rule in this house — respect each other's boundaries.`,
                        `The results were clear — participants who exercised regularly showed significant improvement.`,
                        `He made his position clear — no compromises on environmental standards.`,
                        `The experiment revealed something unexpected — plants responded to music.`
                    ];
                    
                    const lastEmDashExample = numEmDash > 0 ? 
                        emDashExamples[Math.floor(Math.random() * emDashExamples.length)] : '';
                    
                    // Add data point
                    data.push({
                        subreddit,
                        month,
                        num_posts: numPosts,
                        num_emdash: numEmDash,
                        em_dash_percent: emDashPercent,
                        last_emdash_example: lastEmDashExample
                    });
                });
            });
            
            return data;
        }
    </script>
</body>
</html>